#!/usr/bin/env zsh

NEW=$(notmuch count -- tag:new and not tag:sent)

n () {
    c=$1
    shift
    if [[ $c == 0 ]]; then
        icon=mail-read
    else
        icon=mail-unread
    fi
    notify -a notmuch -i $icon "$@"  
}

if [[ $NEW -gt 0 ]]; then
    # echo "classify"
    # $MAIL_DIR/.notmuch/hooks/classify classify tag:new
    echo "refile"
    CHANGED=("${(@f)$($MAIL_DIR/.notmuch/hooks/refile)}")

    SUB=$(notmuch search --limit=10 --format=json -- tag:new and not tag:sent |
              jq -r '
def trunc(n): if (. | length) < n then . else .[:n] + "..." end;
.[]| 
"<small><b>\(.authors|trunc(15)):</b> \(.subject | trunc(30))</small> "
')

    notmuch tag -new -- tag:new

    # if the refiler changed some stuff, we should probably sync again
    if [[ $#CHANGED -gt 1 ]]; then
        echo "$#CHANGED" "$CHANGED"
        pmbsync $CHANGED 2>&1
        ## DANGER WILL ROBINSON
        notmuch new
    fi

    if [ $NEW -ne 0 ]
    then
        n $NEW -u normal "$NEW new mails" "$SUB"
    else
        if [[ -z $QUIET ]] ; then n $NEW -u low "No new mails"; fi
    fi
else
    if [[ -z $QUIET ]] ; then n $NEW -u low "No new mails"; fi
fi
