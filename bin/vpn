#!/usr/bin/env bash

get_interface () {
    journalctl -u cse-vpn|grep Connect: | tail -n 1 | egrep 'ppp[[:digit:]]' -o
}

get_route () {
    ip route get 8.8.8.8 | head -n 1
}

is_active () {
    systemctl is-active cse-vpn >/dev/null
}

connect () {
    echo "* cse $(passm -p webmail.cse.org.uk) *" | tee /etc/ppp/chap-secrets >/dev/null
    systemctl start cse-vpn
}

disconnect () {
    systemctl stop cse-vpn
}

toggle() {
    if is_active; then
        disconnect
    else
        connect
    fi
    status
    notify
}

notify () {
    if is_active; then
        notify-send "VPN on $(get_interface)" "$(get_route)"
    else
        notify-send "VPN" "disconnected"
    fi
}

status () {
    if is_active; then
        echo "$(get_interface) connected"
        get_route
    else
        echo "disconnected"
    fi
}

case $1 in
    toggle|connect|disconnect|notify)
        $1
        ;;
    on)
        connect
        ;;
    off)
        disconnect
        ;;
    *)
        status
        ;;
esac
