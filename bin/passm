#!/usr/bin/env zsh

zparseopts -D c=clip t=type p=pass f+:=field a=auto l=login h=help

getf () {
    echo -E -n "$1" | sed -ne 's/^'"$2"':\(.\+\)/\1/p'
}

getp () {
    echo -E -n "$1" | head -n 1
}

if [[ ! -z $help ]]; then
    echo "usage: $0 [-c] [-t] [-p] [-f field] [-l] [-a]"
    echo "  -c copy fields to clipboard"
    echo "  -t type fields in with xdotool"
    echo "  -p operate on password"
    echo "  -f <field> operate on <field>"
    echo "  -a produce a smb credentials file"
    echo "  -l do a login"
    exit 0
fi

if [[ ! -z $auto ]]; then
    logger "Echoing passwords"
    entry="$1"
    tgt="${2:--}"
    data=""
    E="1"
    data=$(pass show "$entry")
    E=$?

    if [[ $E -ne 0 ]]; then
        notify -u critical "network mount" "$entry - returned $E"
        exit 1
    else
        notify "network mount" "$entry"
    fi

    if [[ ! -z $data ]]; then
        logger "Writing credentials for $entry"
        username=$(getf "$data" "smb-username")
        : ${username:=$(getf "$data" "username")}
        domain=$(getf "$data" "smb-domain")
        password=$(getp "$data")
        out=""
        [[ ! -z "$username" ]] && out="username=${username}"
        [[ ! -z "$password" ]] && out="$out\npassword=${password}"
        [[ ! -z "$domain" ]] && out="$out\ndomain=${domain}"
        if [ -f "$tgt" ]; then
            echo "$out" > "$tgt"
            logger "Delete $tgt in 5..."
            systemd-run --on-active 10 -- rm -f -- "$tgt"
        else
            echo "$out"
        fi
    fi

    exit 0
fi

data=$(pass show "$1")
out=""

proc() {
    if [[ ! -z $clip ]]; then
        notify-send "copied $2"
        echo -E -n "$1" | xclip -quiet -l 1 -selection primary
    elif [[ ! -z $type ]]; then
        # TODO: password revealed in args
        xdotool type "$1"
    else
        echo -E -n "$1"
    fi
}

field=("${(@)field:#-f}")
for f in ${field}; do
    proc "$(getf $data $f)" $f
done

if [[ ! -z $pass ]]; then
    proc "$(getp $data)" "password"
fi

if [[ ! -z $login ]]; then
    # get list of all properties and print them?
    title="$1"
    echo -E "$data" |
        { local -a arr
          read -r password
          if [[ -n $password ]]; then
              arr+='--field=pass:fbtn'
              arr+='sh -c "xdotool type \"$password\""'
              export password
          fi
          local _IFS=$IFS
          IFS=':'
          browser=xdg-open
          export browser
          while read -r key val; do
              case $key in
                  browser)
                      browser=$val
                      export browser
                  ;;
                  url)
                      arr+='--field=browse:fbtn'
                      arr+='sh -c "$browser $url"'
                      url=$val
                      export url
                  ;;
                  *)
                      arr+='--field='$key:'fbtn'
                      arr+='sh -c "xdotool type \"$'$key'\""'
                      eval $key=$val
                      eval export $key
              esac
          done
          IFS=$_IFS
          echo $arr
          yad --form --width 200 --text "$title" $arr '--button=gtk-quit:0' --mouse --no-focus
        }
fi
